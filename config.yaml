# Physics-Based Fan Optimization - Data Collection Configuration
#
# This configuration is used to collect steady-state measurements for fitting
# the thermal model parameters described in PHYSICS_MODEL.md

# Control devices
devices:
  pwm2:
    pwm_number: 2
    name: "CPU Radiator Fan"
    description: "Top radiator fan (pulls air through CPU radiator)"
    min_pwm: 20 # Minimum safe speed (prevents stalling)

  pwm4:
    pwm_number: 4
    name: "Bottom Intake Fans"
    description: "3× bottom case fans (GPU intake, fresh air)"
    min_pwm: 15

  pwm5:
    pwm_number: 5
    name: "Front/Rear Case Fans"
    description: "3× front intake + 1× rear exhaust"
    min_pwm: 15

  # pwm7:
  #   pwm_number: 7
  #   name: "CPU Pump"
  #   description: "AIO pump (coolant circulation)"
  #   min_pwm: 40

# Data collection test matrix
data_collection:
  # Fan/pump speed levels to test (percentage: 0-100)
  # Denser sampling in lower range where fans matter most (diminishing returns above ~60%)
  pwm2_levels: [20, 30, 40, 60, 100]
  pwm4_levels: [0, 15, 30, 50, 80]
  pwm5_levels: [0, 15, 30, 50, 100]
  # pwm7_levels: [40, 60, 80, 100]

  # Load levels to test
  # Note: cpu_load accepts 'stress' flags (e.g. '--cpu 6')
  #       gpu_load accepts 'gpu_load.py' flags (e.g. '--load 50 --memory 30')
  #       Empty string "" means idle/off.
  load_levels:
    - cpu_load: ""
      gpu_load: ""
      description: "Idle"
    #
    # # CPU focused loads (assuming 24 cores)
    - cpu_load: "--cpu 1"
      gpu_load: ""
      description: "CPU (1 cores)"
    - cpu_load: "--cpu 2"
      gpu_load: ""
      description: "CPU (2 cores)"
    - cpu_load: "--cpu 4"
      gpu_load: ""
      description: "CPU (4 cores)"
    - cpu_load: "--cpu 10"
      gpu_load: ""
      description: "CPU (10 cores)"
    - cpu_load: "--cpu 16"
      gpu_load: ""
      description: "CPU (16 cores)"

    # GPU focused loads
    - cpu_load: ""
      gpu_load: "--load 5"
      description: "GPU (5%)"
    - cpu_load: ""
      gpu_load: "--load 10"
      description: "GPU (10%)"
    - cpu_load: ""
      gpu_load: "--load 50"
      description: "GPU (50%)"
    - cpu_load: ""
      gpu_load: "--load 60"
      description: "GPU (60%)"
    - cpu_load: ""
      gpu_load: "--load 70"
      description: "GPU (70%)"
    - cpu_load: ""
      gpu_load: "--load 100"
      description: "GPU (100%)"

    # Mixed loads
    - cpu_load: "--cpu 4"
      gpu_load: "--load 100"
      description: "ML Training"

  # Measurement parameters
  equilibration_check_interval: 1 # How often to sample temperature (seconds)
  equilibration_window: 10.0 # Window to check stability (seconds)
  equilibration_threshold: 0.5 # Max temp change for equilibrium (°C) - relaxed for dynamic CPUs
  equilibration_max_wait: 60 # Maximum wait time before timeout (seconds) - reduced since threshold is looser
  equilibration_min_wait: 15 # Minimum wait before checking (seconds)
  load_stabilization_time: 10 # Time to wait after starting load (seconds)
  measurement_duration: 5 # How long to measure after stabilization (seconds)
  sample_interval: 1 # Sampling interval during measurement (seconds)

  # Sampling configuration (two-phase approach)
  # Phase 1: Single fan sweep (optional) - run each fan alone at varying speeds, others at min
  # Phase 2: Contrast sampling (always) - fill in with samples biased toward lower fan speeds
  num_samples_per_load: 30 # Target number of data points per load level

  # Phase 1: Single Fan Sweep - each fan sweeps through these steps while others at min
  enable_single_fan_sweep: true # Enable/disable Phase 1 (one fan varies, others at min)
  single_fan_sweep_steps: [100, 60, 20, 0] # Percentages of each fan's range (from pwmX_levels)
  single_fan_sweep_repeats: 2 # Number of times to repeat the sweep (for noise averaging)

  sampling_seed: 42

  # Phase 2: Contrast Sampling - 1-2 fans high, rest low
  # This creates data where individual fan contributions are visible
  contrast_sampling:
    num_high_fans: [1, 2] # Randomly pick 1 or 2 fans to be "high" per sample
    high_range: [60, 100] # High fans sample uniformly from this % range
    low_range: [0, 40] # Low fans sample (beta-biased toward low end) from this % range

# Hardware parameters
hardware:
  hwmon_device_name: "nct6799"
  cpu_sensor_name: "k10temp-pci-00c3"
  cpu_sensor_label: "Tctl:"

  # Timeouts and delays
  command_timeout: 5
  ambient_timeout: 300
  retry_delay: 0.1
  max_retries: 3

# Safety limits - abort data point and restore safe speeds if exceeded
safety:
  # Abort thresholds - stop current test point and abort to next
  abort_cpu_temp: 95.0
  abort_gpu_temp: 80.0

  # Emergency shutdown limits (fatal)
  emergency_cpu_temp: 100.0
  emergency_gpu_temp: 85.0

  # Power-dependent minimum fan speeds
  power_dependent_minimums: []
    # Example:
    # - component: "cpu" # Options: cpu, gpu
    #   power_threshold: 100 # If power > threshold
    #   pwm2_min: 20
    #   pwm7_min: 80

  # Never test all fans at minimum simultaneously
  min_total_cooling_effort: 0 # Sum of all PWM percentages must be >= 25%

# Ambient temperature (optional but recommended for accurate model)
ambient:
  source: "home-assistant" # Options: home-assistant, null (to disable)
  ha_url: "http://ha.pi.lan"
  ha_entity_id: "sensor.ewelink_snzb_02p_temperature_2"
  ha_token_env: "HA_TOKEN"

# Output
output:
  directory: "./data"

# ML Model Configuration
# Uses Gradient Boosting Regressor (sklearn) instead of physics equations.
# This handles complex non-linearities and regime shifts (e.g. 6-core vs 24-core heat density).
ml_model:
  type: "gradient_boosting"

  # Features to use for prediction
  features:
    - P_cpu
    - P_gpu
    - T_amb
    - pwm2
    - pwm4
    - pwm5
    # - pwm7

  # Hyperparameters for GradientBoostingRegressor
  hyperparameters:
    n_estimators: 200
    learning_rate: 0.1
    max_depth: 4
    random_state: 42

  # Targets to train models for
  targets:
    - T_cpu
    - T_gpu

  # Filter out thermally-saturated data during training
  # When temps exceed these thresholds, fans appear ineffective due to throttling
  thermal_saturation_filter:
    max_cpu_temp: 90.0 # Filter out T_cpu >= this (°C)
    max_gpu_temp: 85.0 # Filter out T_gpu >= this (°C)
