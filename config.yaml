# Physics-Based Fan Optimization - Data Collection Configuration
#
# This configuration is used to collect steady-state measurements for fitting
# the thermal model parameters described in PHYSICS_MODEL.md

# Control devices
devices:
  pwm2:
    pwm_number: 2
    name: "CPU Radiator Fan"
    description: "Top radiator fan (pulls air through CPU radiator)"
    min_pwm: 20 # Minimum safe speed (prevents stalling)

  pwm4:
    pwm_number: 4
    name: "Bottom Intake Fans"
    description: "3× bottom case fans (GPU intake, fresh air)"
    min_pwm: 15

  pwm5:
    pwm_number: 5
    name: "Front/Rear Case Fans"
    description: "3× front intake + 1× rear exhaust"
    min_pwm: 15

  pwm7:
    pwm_number: 7
    name: "CPU Pump"
    description: "AIO pump (coolant circulation)"
    min_pwm: 60

# Data collection test matrix
data_collection:
  # Fan/pump speed levels to test (percentage: 0-100)
  pwm2_levels: [20, 100]
  pwm4_levels: [0, 80]
  pwm5_levels: [15, 100]
  pwm7_levels: [60, 100]

  # Load levels to test
  # Note: cpu_load accepts 'stress' flags (e.g. '--cpu 6')
  #       gpu_load accepts 'gpu-burn' flags (e.g. '-m 50%' or '-tc')
  #       Empty string "" means idle/off.
  load_levels:
    - cpu_load: ""
      gpu_load: ""
      description: "Idle"
    
    # CPU focused loads (assuming 24 cores)
    - cpu_load: "--cpu 6"
      gpu_load: ""
      description: "CPU Heat Max (6 cores)"
    - cpu_load: "--cpu 24"
      gpu_load: ""
      description: "CPU Full Load (24 cores)"
      
    # GPU focused loads
    - cpu_load: ""
      gpu_load: "-m 50%"
      description: "GPU Moderate Load"
    - cpu_load: ""
      gpu_load: " " # Space to run default full burn
      description: "GPU Full Load"

    # Mixed loads
    - cpu_load: "--cpu 12"
      gpu_load: "-m 50%"
      description: "Mixed Moderate"
    - cpu_load: "--cpu 24"
      gpu_load: " "
      description: "Full System Load"

  # Measurement parameters
  equilibration_check_interval: 1 # How often to sample temperature (seconds)
  equilibration_window: 10.0 # Window to check stability (seconds)
  equilibration_threshold: 0.1 # Max temp change for equilibrium (°C)
  equilibration_max_wait: 120 # Maximum wait time before timeout (seconds)
  equilibration_min_wait: 10 # Minimum wait before checking (seconds)
  load_stabilization_time: 10 # Time to wait after starting load (seconds)
  measurement_duration: 5 # How long to measure after stabilization (seconds)
  sample_interval: 1 # Sampling interval during measurement (seconds)

  # Smart test point selection
  sampling_strategy: "latin_hypercube" # Options: latin_hypercube (recommended), random, grid
  num_samples_per_load: 50 # Target number of data points per load level
  sampling_seed: 42

# Hardware parameters
hardware:
  hwmon_device_name: "nct6799"
  cpu_sensor_name: "k10temp-pci-00c3"
  cpu_sensor_label: "Tctl:"

  # Timeouts and delays
  command_timeout: 5
  ambient_timeout: 300
  retry_delay: 0.1
  max_retries: 3

# Safety limits - abort data point and restore safe speeds if exceeded
safety:
  # Abort thresholds - stop current test point and abort to next
  abort_cpu_temp: 95.0
  abort_gpu_temp: 80.0

  # Emergency shutdown limits (fatal)
  emergency_cpu_temp: 100.0
  emergency_gpu_temp: 85.0

  # Power-dependent minimum fan speeds
  power_dependent_minimums:
    - component: "cpu" # Options: cpu, gpu
      power_threshold: 100 # If power > threshold
      pwm2_min: 50
      pwm7_min: 80

  # Never test all fans at minimum simultaneously
  min_total_cooling_effort: 25 # Sum of all PWM percentages must be >= 25%

# Ambient temperature (optional but recommended for accurate model)
ambient:
  source: "home-assistant" # Options: home-assistant, null (to disable)
  ha_url: "http://ha.pi.lan"
  ha_entity_id: "sensor.ewelink_snzb_02p_temperature_2"
  ha_token_env: "HA_TOKEN"

# Output
output:
  directory: "./data"

# Thermal model configuration (for fitting)
# SIMPLIFIED MODEL based on data analysis showing minimal cooling effects
model:
  # Model structure - defines which devices affect which components
  # CONDUCTANCE MODEL: R_total = R_serial + 1 / (G_base + sum(k*pwm))
  # R_base_* -> R_serial (Irreducible resistance)
  # R_*_min  -> G_base (Baseline natural conductance)
  # k_*      -> Conductance contribution
  structure:
    cpu:
      base_resistance: R_base_cpu # Irreducible R (serial)
      pump_effect:
        device: pwm7
        param: k_pump
      fans:
        pwm2:
          param: k_rad_fan
          pump_coupled: false
        pwm4:
          param: k_intake
        pwm5:
          param: k_exhaust
      baseline: R_min # Baseline Conductance (G_base)

    gpu:
      base_resistance: R_base_gpu # Irreducible R (serial)
      fans:
        pwm4:
          param: k_gpu_intake
        pwm5:
          param: k_gpu_exhaust
      baseline: R_gpu_min # Baseline Conductance (G_base)

  # Initial guesses - adjusted for Conductance Model
  # CPU R~0.38 => R_serial~0.30 + 1/G~0.08 (G~12.5)
  # GPU R~0.13 => R_serial~0.10 + 1/G~0.03 (G~33.0)
  initial_guesses:
    R_base_cpu: 0.30      # Irreducible resistance
    k_pump: 5.0           # Pump conductance contrib
    k_rad_fan: 5.0        # Rad fan conductance contrib
    k_intake: 2.0         # Intake conductance contrib
    k_exhaust: 2.0        # Exhaust conductance contrib
    R_min: 10.0           # G_base (Baseline Conductance)

    R_base_gpu: 0.10      # Irreducible resistance
    k_gpu_intake: 10.0    # Intake conductance contrib
    k_gpu_exhaust: 10.0   # Exhaust conductance contrib
    R_gpu_min: 30.0       # G_base (Baseline Conductance)

  # Parameter bounds - appropriate for Conductance Model
  bounds:
    R_base_cpu: [0.10, 0.40]      # R_serial must be < Total R (~0.4)
    k_pump: [0, 50.0]             # Conductance gain
    k_rad_fan: [0, 50.0]
    k_intake: [0, 50.0]
    k_exhaust: [0, 50.0]
    R_min: [1.0, 100.0]           # G_base (Conductance)

    R_base_gpu: [0.05, 0.15]      # R_serial must be < Total R (~0.13)
    k_gpu_intake: [0, 100.0]
    k_gpu_exhaust: [0, 100.0]
    R_gpu_min: [10.0, 200.0]      # G_base (Conductance)
