# Physics-Based Fan Optimization - Data Collection Configuration
#
# This configuration is used to collect steady-state measurements for fitting
# the thermal model parameters described in PHYSICS_MODEL.md

# Control devices
devices:
  pwm2:
    pwm_number: 2
    name: "CPU Radiator Fan"
    description: "Top radiator fan (pulls air through CPU radiator)"
    min_pwm: 20 # Minimum safe speed (prevents stalling)

  pwm4:
    pwm_number: 4
    name: "Bottom Intake Fans"
    description: "3× bottom case fans (GPU intake, fresh air)"
    min_pwm: 15

  pwm5:
    pwm_number: 5
    name: "Front/Rear Case Fans"
    description: "3× front intake + 1× rear exhaust"
    min_pwm: 15

  pwm7:
    pwm_number: 7
    name: "CPU Pump"
    description: "AIO pump (coolant circulation)"
    min_pwm: 60

# Data collection test matrix
data_collection:
  # Fan/pump speed levels to test (percentage: 0-100)
  pwm2_levels: [20, 100]
  pwm4_levels: [0, 80]
  pwm5_levels: [15, 100]
  pwm7_levels: [60, 100]

  # Load levels to test
  load_levels:
    - cpu_percent: 0
      gpu_percent: 0
      description: "Idle"
    - cpu_percent: 50
      gpu_percent: 0
      description: "Moderate CPU"
    - cpu_percent: 100
      gpu_percent: 0
      description: "Full CPU"
    - cpu_percent: 0
      gpu_percent: 25
      description: "Moderate GPU"
    - cpu_percent: 0
      gpu_percent: 50
      description: "Full GPU"
    - cpu_percent: 50
      gpu_percent: 50
      description: "Mixed load"
    - cpu_percent: 100
      gpu_percent: 50
      description: "Full system load"

  # Measurement parameters
  equilibration_check_interval: 1 # How often to sample temperature (seconds)
  equilibration_window: 10.0 # Window to check stability (seconds)
  equilibration_threshold: 0.1 # Max temp change for equilibrium (°C)
  equilibration_max_wait: 120 # Maximum wait time before timeout (seconds)
  equilibration_min_wait: 10 # Minimum wait before checking (seconds)
  load_stabilization_time: 10 # Time to wait after starting load (seconds)
  measurement_duration: 5 # How long to measure after stabilization (seconds)
  sample_interval: 1 # Sampling interval during measurement (seconds)

  # Smart test point selection
  sampling_strategy: "latin_hypercube" # Options: latin_hypercube (recommended), random, grid
  num_samples_per_load: 50 # Target number of data points per load level
  sampling_seed: 42

# Hardware parameters
hardware:
  hwmon_device_name: "nct6799"
  cpu_sensor_name: "k10temp-pci-00c3"
  cpu_sensor_label: "Tctl:"

  # Timeouts and delays
  command_timeout: 5
  ambient_timeout: 300
  retry_delay: 0.1
  max_retries: 3

# Safety limits - abort data point and restore safe speeds if exceeded
safety:
  # Abort thresholds - stop current test point and abort to next
  abort_cpu_temp: 95.0
  abort_gpu_temp: 80.0

  # Emergency shutdown limits (fatal)
  emergency_cpu_temp: 100.0
  emergency_gpu_temp: 85.0

  # Power-dependent minimum fan speeds
  power_dependent_minimums:
    - component: "cpu" # Options: cpu, gpu
      power_threshold: 100 # If power > threshold
      pwm2_min: 50
      pwm7_min: 80

  # Never test all fans at minimum simultaneously
  min_total_cooling_effort: 25 # Sum of all PWM percentages must be >= 25%

# Ambient temperature (optional but recommended for accurate model)
ambient:
  source: "home-assistant" # Options: home-assistant, null (to disable)
  ha_url: "http://ha.pi.lan"
  ha_entity_id: "sensor.ewelink_snzb_02p_temperature_2"
  ha_token_env: "HA_TOKEN"

# Output
output:
  directory: "./data"

# Thermal model configuration (for fitting)
# SIMPLIFIED MODEL based on data analysis showing minimal cooling effects
model:
  # Model structure - defines which devices affect which components
  # Analysis showed thermal resistance is nearly constant (~0.39 °C/W for CPU)
  # with only ~1°C difference across full cooling range
  structure:
    cpu:
      # Simplified model: T = T_amb + P × (R_base - small_cooling_effects)
      # R_base dominates, cooling provides minor adjustment
      base_resistance: R_base_cpu
      pump_effect:
        device: pwm7
        param: k_pump  # Small reduction in R from pump
      fans:
        pwm2:
          param: k_rad_fan  # Small effect from radiator fan
          pump_coupled: false  # Simplified - no coupling
        pwm4:
          param: k_intake  # Minor effect from intake fans
        pwm5:
          param: k_exhaust  # Minor effect from exhaust fans
      baseline: R_min  # Minimum resistance floor

    gpu:
      # GPU shows better cooling response than CPU
      base_resistance: R_base_gpu
      fans:
        pwm4:
          param: k_gpu_intake  # Intake fans help GPU
        pwm5:
          param: k_gpu_exhaust  # Exhaust fans help GPU
      baseline: R_gpu_min  # Minimum resistance floor

  # Initial guesses - based on observed thermal resistance
  # CPU: ~0.39 °C/W, GPU: ~0.30 °C/W (when loaded)
  initial_guesses:
    # CPU parameters
    R_base_cpu: 0.42      # Start slightly above observed mean
    k_pump: 0.0001        # Very small pump effect
    k_rad_fan: 0.0001     # Very small radiator fan effect
    k_intake: 0.00005     # Tiny intake effect on CPU
    k_exhaust: 0.00005    # Tiny exhaust effect on CPU
    R_min: 0.001          # Small baseline conductance

    # GPU parameters - data shows nearly constant R~0.127 at 300W
    R_base_gpu: 0.13      # Close to observed resistance
    k_gpu_intake: 0.0001  # Minimal effect (insufficient data variation)
    k_gpu_exhaust: 0.0001 # Minimal effect (insufficient data variation)
    R_gpu_min: 0.0001     # Very small baseline

  # Parameter bounds - realistic ranges based on data
  bounds:
    # CPU bounds - observed R range: 0.27-0.41
    R_base_cpu: [0.35, 0.50]      # Base must be in realistic range
    k_pump: [0, 0.01]             # Small effect only
    k_rad_fan: [0, 0.01]          # Small effect only
    k_intake: [0, 0.05]           # Allowed to be larger (observed hitting 0.01)
    k_exhaust: [0, 0.01]          # Small effect
    R_min: [0, 0.05]              # Small baseline

    # GPU bounds - observed R~0.127 at 300W
    R_base_gpu: [0.10, 0.20]       # Tight range around observed value
    k_gpu_intake: [0, 0.05]        # Relaxed: data suggests ~0.003-0.004
    k_gpu_exhaust: [0, 0.05]       # Relaxed: data suggests ~0.002
    R_gpu_min: [0, 0.01]           # Very small baseline
