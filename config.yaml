# Fan Optimization - Hardware and Data Collection Configuration
#
# This configuration contains hardware-specific settings and data collection parameters.
# Model training and optimization parameters are in params.yaml

# Control devices
devices:
  pwm2:
    pwm_number: 2
    name: "CPU Radiator Fan"
    description: "Top radiator fan (pulls air through CPU radiator)"
    min_pwm: 20 # Minimum PWM value (from data collection)
    stall_pwm: 20 # PWM below which fan stalls

  pwm4:
    pwm_number: 4
    name: "Bottom Intake Fans"
    description: "3× bottom case fans (GPU intake, fresh air)"
    min_pwm: 0 # Minimum PWM value (from data collection)
    stall_pwm: 15 # PWM below which fan stalls

  pwm5:
    pwm_number: 5
    name: "Front/Rear Case Fans"
    description: "3× front intake + 1× rear exhaust"
    min_pwm: 0 # Minimum PWM value (from data collection)
    stall_pwm: 15 # PWM below which fan stalls

  # pwm7:
  #   pwm_number: 7
  #   name: "CPU Pump"
  #   description: "AIO pump (coolant circulation)"
  #   min_pwm: 40 # Minimum PWM value (from data collection)
  #   stall_pwm: 40 # PWM below which pump stalls

# Hardware parameters
hardware:
  hwmon_device_name: "nct6799"
  cpu_sensor_name: "k10temp-pci-00c3"
  cpu_sensor_label: "Tctl:"

  # Timeouts and delays
  command_timeout: 5
  ambient_timeout: 300
  retry_delay: 0.1
  max_retries: 3

# Ambient temperature (optional but recommended for accurate model)
ambient:
  source: "home-assistant" # Options: home-assistant, null (to disable)
  ha_url: "http://ha.pi.lan"
  ha_entity_id: "sensor.ewelink_snzb_02p_temperature_2"
  ha_token_env: "HA_TOKEN"

# Plot configuration
# Specify which fans to use for specific plots and their relationships
plot_config:
  # Fan interaction plot
  # Shows how two fans interact to affect CPU temperature
  interaction_plot:
    enabled: true
    fan1: "pwm2" # Primary fan (e.g., radiator fan)
    fan2: "pwm5" # Secondary fan (e.g., case fans)
    component: "cpu" # Which component this interaction affects (cpu or gpu)

  # Thermal resistance plots
  # R = (T - T_amb) / Power
  thermal_resistance:
    cpu:
      x_axis: "pwm2" # Fan to plot on x-axis
      color_by: null # Fan to use for color gradient (null = use power)
    gpu:
      x_axis: "pwm4" # Fan to plot on x-axis
      color_by: null # Fan to use for color gradient (null = use power)

  # 3D surface plots
  # Temperature as function of two variables
  surface_3d:
    cpu:
      x_axis: "pwm2" # First fan
      y_axis: "P_cpu" # Second variable (can be another fan or P_cpu)
    gpu:
      x_axis: "pwm4" # First fan
      y_axis: "P_gpu" # Second variable

  # Cooling effectiveness plots
  # Shows normalized temperature rise vs fan speed
  cooling_effectiveness:
    cpu_fans: ["pwm2"] # Primary fans affecting CPU cooling
    gpu_fans: ["pwm4", "pwm5"] # Primary fans affecting GPU cooling

# Time-series data collection for MPC thermal modeling
data_collection:
  # PWM levels (percentage: 0-100) - biased toward low fan speeds
  pwm2_levels: [20, 25, 30, 35, 40, 50, 70, 100]
  pwm4_levels: [0, 10, 15, 20, 30, 50, 80]
  pwm5_levels: [0, 10, 15, 20, 30, 50, 100]

  # Episode types for different PWM variation strategies
  episode_types:
    - mode: "single_isolation"
      repeats_per_load: 3 # × 3 fans = 9 episodes per load

    - mode: "pair_isolation"
      repeats_per_load: 3 # × 3 pairs = 9 episodes per load

    - mode: "full_sequential"
      repeats_per_load: 3 # = 3 episodes per load

  # Load levels to test
  # Note: cpu_load accepts 'stress' flags (e.g. '--cpu 6')
  #       gpu_load accepts 'gpu_load.py' flags (e.g. '--load 50 --memory 30')
  #       Empty string "" means idle/off.
  load_levels:
    - cpu_load: ""
      gpu_load: ""
      description: "idle"

    # CPU focused loads (assuming 24 cores)
    - cpu_load: "--cpu 1"
      gpu_load: ""
      description: "cpu_1"
    - cpu_load: "--cpu 2"
      gpu_load: ""
      description: "cpu_2"
    - cpu_load: "--cpu 4"
      gpu_load: ""
      description: "cpu_4"
    - cpu_load: "--cpu 6"
      gpu_load: ""
      description: "cpu_6"
    - cpu_load: "--cpu 10"
      gpu_load: ""
      description: "cpu_10"
    - cpu_load: "--cpu 16"
      gpu_load: ""
      description: "cpu_16"
    - cpu_load: "--cpu 24"
      gpu_load: ""
      description: "cpu_24"

    # GPU focused loads
    - cpu_load: ""
      gpu_load: "--load 5"
      description: "gpu_5pct"
    - cpu_load: ""
      gpu_load: "--load 10"
      description: "gpu_10pct"
    - cpu_load: ""
      gpu_load: "--load 50"
      description: "gpu_50pct"
    - cpu_load: ""
      gpu_load: "--load 60"
      description: "gpu_60pct"
    - cpu_load: ""
      gpu_load: "--load 70"
      description: "gpu_70pct"
    - cpu_load: ""
      gpu_load: "--load 100"
      description: "gpu_100pct"

    # Mixed loads
    - cpu_load: "--cpu 1"
      gpu_load: "--load 100"
      description: "cpu_1_gpu_100pct"
    - cpu_load: "--cpu 2"
      gpu_load: "--load 100"
      description: "cpu_2_gpu_100pct"
    - cpu_load: "--cpu 24"
      gpu_load: "--load 100"
      description: "cpu_24_gpu_100pct"
    - cpu_load: "--cpu 4"
      gpu_load: "--load 50"
      description: "cpu_4_gpu_50pct"
    - cpu_load: "--cpu 8"
      gpu_load: "--load 70"
      description: "cpu_8_gpu_70pct"
    - cpu_load: "--cpu 6"
      gpu_load: "--load 30"
      description: "cpu_6_gpu_30pct"
    - cpu_load: "--cpu 12"
      gpu_load: "--load 50"
      description: "cpu_12_gpu_50pct"

  # Time-series collection parameters
  sample_interval: 1.0 # Seconds between samples (1Hz)
  episode_duration: 180 # Episode length in seconds (3 minutes)
  load_stabilization_time: 5 # Wait after load change before episode

  # PWM schedule generation
  pwm_schedule:
    min_hold_time: 20 # Minimum seconds at each PWM level
    max_hold_time: 60 # Maximum seconds at each PWM level

  sampling_seed: 42

# Safety limits - abort data point and restore safe speeds if exceeded
safety:
  # Abort thresholds - stop current test point and abort to next
  abort_cpu_temp: 95.0
  abort_gpu_temp: 80.0
  abort_cooldown_time: 20 # Seconds to wait at full speed after abort

  # Emergency shutdown limits (fatal)
  emergency_cpu_temp: 100.0
  emergency_gpu_temp: 85.0

  # Power-dependent minimum fan speeds
  power_dependent_minimums: []
    # Example:
    # - component: "cpu" # Options: cpu, gpu
    #   power_threshold: 100 # If power > threshold
    #   pwm2_min: 20
    #   pwm7_min: 80

  # Never test all fans at minimum simultaneously
  min_total_cooling_effort: 0 # Sum of all PWM percentages must be >= 25%
