# Physics-Based Fan Optimization - Data Collection Configuration
#
# This configuration is used to collect steady-state measurements for fitting
# the thermal model parameters described in PHYSICS_MODEL.md

# Control devices
devices:
  pwm2:
    pwm_number: 2
    name: "CPU Radiator Fan"
    description: "Top radiator fan (pulls air through CPU radiator)"
    min_pwm: 20 # Minimum safe speed (prevents stalling)

  pwm4:
    pwm_number: 4
    name: "Bottom Intake Fans"
    description: "3× bottom case fans (GPU intake, fresh air)"
    min_pwm: 15

  pwm5:
    pwm_number: 5
    name: "Front/Rear Case Fans"
    description: "3× front intake + 1× rear exhaust"
    min_pwm: 15

  pwm7:
    pwm_number: 7
    name: "CPU Pump"
    description: "AIO pump (coolant circulation)"
    min_pwm: 60

# Data collection test matrix
data_collection:
  # Fan/pump speed levels to test (percentage: 0-100)
  pwm2_levels: [20, 100]
  pwm4_levels: [0, 80]
  pwm5_levels: [0, 100]
  pwm7_levels: [60, 100]

  # Load levels to test
  # Note: cpu_load accepts 'stress' flags (e.g. '--cpu 6')
  #       gpu_load accepts 'gpu_load.py' flags (e.g. '--load 50 --memory 30')
  #       Empty string "" means idle/off.
  load_levels:
    # - cpu_load: ""
    #   gpu_load: ""
    #   description: "Idle"

    # CPU focused loads (assuming 24 cores)
    - cpu_load: "--cpu 1"
      gpu_load: ""
      description: "CPU (1 cores)"
    - cpu_load: "--cpu 2"
      gpu_load: ""
      description: "CPU (2 cores)"
    - cpu_load: "--cpu 4"
      gpu_load: ""
      description: "CPU (4 cores)"
    - cpu_load: "--cpu 6"
      gpu_load: ""
      description: "CPU (6 cores)"
    - cpu_load: "--cpu 10"
      gpu_load: ""
      description: "CPU (10 cores)"
    - cpu_load: "--cpu 16"
      gpu_load: ""
      description: "CPU (16 cores)"
    - cpu_load: "--cpu 24"
      gpu_load: ""
      description: "CPU (24 cores)"

    # GPU focused loads
    - TODO

    # Mixed loads
    - TODO

  # Measurement parameters
  equilibration_check_interval: 1 # How often to sample temperature (seconds)
  equilibration_window: 10.0 # Window to check stability (seconds)
  equilibration_threshold: 0.1 # Max temp change for equilibrium (°C)
  equilibration_max_wait: 120 # Maximum wait time before timeout (seconds)
  equilibration_min_wait: 10 # Minimum wait before checking (seconds)
  load_stabilization_time: 10 # Time to wait after starting load (seconds)
  measurement_duration: 5 # How long to measure after stabilization (seconds)
  sample_interval: 1 # Sampling interval during measurement (seconds)

  # Smart test point selection
  sampling_strategy: "latin_hypercube" # Options: latin_hypercube (recommended), random, grid
  num_samples_per_load: 15 # Target number of data points per load level
  sampling_seed: 42

# Hardware parameters
hardware:
  hwmon_device_name: "nct6799"
  cpu_sensor_name: "k10temp-pci-00c3"
  cpu_sensor_label: "Tctl:"

  # Timeouts and delays
  command_timeout: 5
  ambient_timeout: 300
  retry_delay: 0.1
  max_retries: 3

# Safety limits - abort data point and restore safe speeds if exceeded
safety:
  # Abort thresholds - stop current test point and abort to next
  abort_cpu_temp: 95.0
  abort_gpu_temp: 80.0

  # Emergency shutdown limits (fatal)
  emergency_cpu_temp: 100.0
  emergency_gpu_temp: 85.0

  # Power-dependent minimum fan speeds
  power_dependent_minimums:
    - component: "cpu" # Options: cpu, gpu
      power_threshold: 100 # If power > threshold
      pwm2_min: 20
      pwm7_min: 80

  # Never test all fans at minimum simultaneously
  min_total_cooling_effort: 15 # Sum of all PWM percentages must be >= 25%

# Ambient temperature (optional but recommended for accurate model)
ambient:
  source: "home-assistant" # Options: home-assistant, null (to disable)
  ha_url: "http://ha.pi.lan"
  ha_entity_id: "sensor.ewelink_snzb_02p_temperature_2"
  ha_token_env: "HA_TOKEN"

# Output
output:
  directory: "./data"

# ML Model Configuration
# Uses Gradient Boosting Regressor (sklearn) instead of physics equations.
# This handles complex non-linearities and regime shifts (e.g. 6-core vs 24-core heat density).
ml_model:
  type: "gradient_boosting"

  # Features to use for prediction
  features:
    - P_cpu
    - P_gpu
    - T_amb
    - pwm2
    - pwm4
    - pwm5
    - pwm7

  # Engineered features (automatically generated)
  # inv_pwm* = 1 / (pwm + 10)
  # P_*_pwm* = Power * inv_pwm (Interaction)

  # Hyperparameters for GradientBoostingRegressor
  hyperparameters:
    n_estimators: 200
    learning_rate: 0.1
    max_depth: 4
    random_state: 42

  # Targets to train models for
  targets:
    - T_cpu
    - T_gpu
